# 夹爪控制使用指南

本指南说明如何在VR遥操作中使用手的张合来控制机器人夹爪。

## 📋 前提条件

1. 机器人装有**因时二指夹爪**
2. 已完成VR系统的基本设置（SSL证书等）
3. Quest头显和PC在同一WiFi网络

## 🎯 功能概述

系统支持两种模式的夹爪控制：

### 1. 手部追踪模式（Hand Tracking）

- **握紧拳头** → 夹爪闭合
- **张开手掌** → 夹爪打开
- 夹爪开口度与手的张合程度实时同步
- 范围：完全张开(1000) ↔ 完全闭合(0)

### 2. 手柄模式（Controller）

- **按下握把按钮(Grip)** → 夹爪闭合
- **松开握把按钮** → 夹爪打开
- 夹爪开口度与握把按压深度实时同步
- 范围：完全张开(1000) ↔ 完全闭合(0)

## 🚀 快速开始

### 步骤1: 测试夹爪硬件（可选但推荐）

在使用VR控制前，建议先单独测试夹爪：

```bash
python test_gripper.py
```

这个脚本会：
1. 连接到机器人
2. 自动测试夹爪从完全张开到完全闭合
3. 提供手动控制模式，可输入任意开口度

### 步骤2: VR控制

运行VR控制脚本：

```bash
python step7_quest_real_control.py
```

按照提示：
1. 确认安全检查
2. 选择模式（1=手柄，2=手部追踪）
3. 在Quest中访问VR界面
4. 等待机器人初始化
5. 标定VR系统
6. 开始控制！

## 🎮 操作说明

### 手部追踪模式

1. **正常操作**：
   - 移动手控制机器人手臂
   - 握紧拳头让夹爪抓取物体
   - 张开手掌松开物体

2. **注意事项**：
   - 确保Quest能清晰看到双手
   - 避免快速移动导致追踪丢失
   - 保持手在Quest视野范围内

### 手柄模式

1. **正常操作**：
   - 移动手柄控制机器人手臂
   - 按下Grip键让夹爪抓取物体
   - 松开Grip键松开物体

2. **按钮说明**：
   - Grip (握把)：控制夹爪
   - Trigger (扳机)：未使用
   - 摇杆：未使用
   - A/B按钮：未使用

## 📊 实时监控

运行时，控制台会显示：

```
左: [+0.050, -0.020, +0.100]  右: [+0.050, +0.020, +0.100]  夹爪 L: 350 R: 350
```

- **左/右坐标**：手臂位置偏移（米）
- **夹爪 L/R**：左右夹爪开口度（0-1000）
  - 1000 = 完全张开
  - 0 = 完全闭合

## ⚙️ 参数调整

### 调整夹爪速度和力度

编辑 `step7_quest_real_control.py`，在 `RobotController.__init__()` 中修改：

```python
# 夹爪参数
self.gripper_speed = 500  # 速度 [0-1000]，默认500
self.gripper_force = 300  # 力度 [0-1000]，默认300
```

**参数说明**：
- `gripper_speed`: 夹爪移动速度
  - 较小值：慢速精确控制
  - 较大值：快速响应
- `gripper_force`: 夹爪抓取力度
  - 较小值：适合抓取脆弱物体
  - 较大值：适合抓取重物

### 调整控制映射

默认映射是线性的：
- 手完全张开 = 夹爪完全张开
- 手完全握紧 = 夹爪完全闭合

如需修改映射关系，编辑 `step7_quest_real_control.py` 主循环中的夹爪控制部分：

```python
# 原始线性映射
left_gripper = int((1.0 - left_squeeze) * 1000)

# 示例：非线性映射（更灵敏）
# left_gripper = int((1.0 - left_squeeze**2) * 1000)

# 示例：限制范围（只使用50%-100%开口度）
# left_gripper = int((0.5 + (1.0 - left_squeeze) * 0.5) * 1000)
```

## 🔧 故障排除

### 问题：夹爪没有响应

**检查清单**：
1. ✅ 机器人已初始化到Mode 1
2. ✅ 确认装有因时二指夹爪
3. ✅ 查看控制台是否显示夹爪数值变化
4. ✅ 手部追踪模式：Quest是否正确识别手势
5. ✅ 手柄模式：Grip按钮是否按下

**调试步骤**：
1. 运行 `test_gripper.py` 确认硬件正常
2. 在VR控制中检查控制台的夹爪数值
3. 如果数值变化但夹爪不动，检查机器人状态
4. 如果数值不变，检查VR输入是否正常

### 问题：夹爪移动太慢/太快

调整 `gripper_speed` 参数（见上文）

### 问题：夹爪力度不够/太大

调整 `gripper_force` 参数（见上文）

### 问题：控制不够精确

**手部追踪模式**：
- 确保光线充足
- 保持手在Quest视野中央
- 避免快速移动

**手柄模式**：
- Grip按钮支持模拟输入，慢慢按压
- 避免快速按下/松开

## 📝 API参考

夹爪控制使用以下WebSocket命令：

```json
{
  "title": "request_set_claw_cmd",
  "data": {
    "left_opening": 500,   // 开口度 [0-1000]
    "left_speed": 500,     // 速度 [0-1000]
    "left_force": 300,     // 力度 [0-1000]
    "left_mode": 3,        // 模式: 3=位控
    
    "right_opening": 500,
    "right_speed": 500,
    "right_force": 300,
    "right_mode": 3
  }
}
```

**模式说明**：
- `mode=1`: 夹取模式
- `mode=2`: 松开模式
- `mode=3`: 位控模式（当前使用）

## 💡 使用技巧

1. **先测试后使用**：使用 `test_gripper.py` 熟悉夹爪特性
2. **渐进式控制**：从小开口度变化开始，逐步适应
3. **保持平稳**：避免快速张合手，保持动作平稳
4. **监控反馈**：注意控制台的数值反馈
5. **安全第一**：首次使用时建议在空载状态下测试

## 🎓 示例场景

### 抓取物体

1. 移动手臂靠近物体
2. 张开手掌，确保夹爪完全张开
3. 定位到抓取位置
4. 慢慢握紧拳头/按下Grip
5. 感觉到阻力时停止（查看控制台数值）
6. 移动到目标位置
7. 张开手掌/松开Grip释放物体

### 精确操作

1. 将 `gripper_speed` 设置为较小值（如300）
2. 使用手部追踪模式（更直观）
3. 保持手在Quest视野中央
4. 缓慢调整手的张合程度
5. 观察控制台的夹爪数值反馈

## 📞 支持

如有问题，请检查：
- README.md - 完整文档
- test_gripper.py - 夹爪测试工具
- step7_quest_real_control.py - 源代码和注释

